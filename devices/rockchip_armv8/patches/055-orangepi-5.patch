From 32ea24c8cbe20664e91630335144483d1ec3c777 Mon Sep 17 00:00:00 2001
From: Tianling Shen <cnsztl@immortalwrt.org>
Date: Fri, 26 Jan 2024 17:46:26 +0800
Subject: [PATCH] rockchip: add OrangePi 5 (Plus) support

Signed-off-by: Tianling Shen <cnsztl@immortalwrt.org>
---
 .../armv8/base-files/etc/board.d/02_network   |   6 +-
 target/linux/rockchip/image/armv8.mk          |  17 +
 ...7-arm64-dts-rockchip-Add-Orange-Pi-5.patch | 693 ++++++++++++++
 ...-add-USB3-host-on-rk3588s-orangepi-5.patch |  24 +
 ...chip-Support-poweroff-on-Orange-Pi-5.patch |  25 +
 ...s-rockchip-Add-board-device-tree-for.patch | 897 ++++++++++++++++++
 ...-rockchip-use-system-LED-for-OpenWrt.patch |  49 +
 .../210-rockchip-rk356x-add-support-for-new-boards.patch        |   5 +-
 8 files changed, 1712 insertions(+), 4 deletions(-)
 create mode 100644 target/linux/rockchip/patches-6.1/055-01-v6.7-arm64-dts-rockchip-Add-Orange-Pi-5.patch
 create mode 100644 target/linux/rockchip/patches-6.1/055-02-v6.8-arm64-dts-rockchip-add-USB3-host-on-rk3588s-orangepi-5.patch
 create mode 100644 target/linux/rockchip/patches-6.1/055-03-v6.8-arm64-dts-rockchip-Support-poweroff-on-Orange-Pi-5.patch
 create mode 100644 target/linux/rockchip/patches-6.1/056-01-v6.7-arm64-dts-rockchip-Add-board-device-tree-for.patch

diff --git a/target/linux/rockchip/armv8/base-files/etc/board.d/02_network b/target/linux/rockchip/armv8/base-files/etc/board.d/02_network
index 1f3d8ef8336..ba90653e312 100644
--- a/target/linux/rockchip/armv8/base-files/etc/board.d/02_network
+++ b/target/linux/rockchip/armv8/base-files/etc/board.d/02_network
@@ -25,7 +25,8 @@ rockchip_setup_interfaces()
 		ucidef_set_interfaces_lan_wan 'eth1' 'eth2'
 		;;
 	friendlyarm,nanopi-r5c|\
-	lunzn,fastrhino-r66s)
+	lunzn,fastrhino-r66s|\
+	xunlong,orangepi-5-plus)
 		ucidef_set_interfaces_lan_wan 'eth0' 'eth1'
 		;;
 	friendlyarm,nanopi-r5s)
@@ -61,7 +62,8 @@ rockchip_setup_macs()
 		lan_mac=$(macaddr_add "$wan_mac" 1)
 		;;
 	friendlyarm,nanopi-r5c|\
-	friendlyarm,nanopi-r6c)
+	friendlyarm,nanopi-r6c|\
+	xunlong,orangepi-5-plus)
 		wan_mac=$(macaddr_generate_from_mmc_cid mmcblk*)
 		lan_mac=$(macaddr_add "$wan_mac" 1)
 		;;
diff --git a/target/linux/rockchip/image/armv8.mk b/target/linux/rockchip/image/armv8.mk
index 3f31907657d..ec2dadf561a 100644
--- a/target/linux/rockchip/image/armv8.mk
+++ b/target/linux/rockchip/image/armv8.mk
@@ -239,6 +239,23 @@ define Device/radxa_rock-pi-e
 endef
 TARGET_DEVICES += radxa_rock-pi-e
 
+define Device/xunlong_orangepi-5
+  DEVICE_VENDOR := Xunlong
+  DEVICE_MODEL := Orange Pi 5
+  SOC := rk3588s
+  BOOT_FLOW := pine64-img
+endef
+TARGET_DEVICES += xunlong_orangepi-5
+
+define Device/xunlong_orangepi-5-plus
+  DEVICE_VENDOR := Xunlong
+  DEVICE_MODEL := Orange Pi 5 Plus
+  SOC := rk3588
+  BOOT_FLOW := pine64-img
+  DEVICE_PACKAGES := kmod-r8125
+endef
+TARGET_DEVICES += xunlong_orangepi-5-plus
+
 define Device/xunlong_orangepi-r1-plus
   DEVICE_VENDOR := Xunlong
   DEVICE_MODEL := Orange Pi R1 Plus
diff --git a/target/linux/rockchip/patches-6.1/055-02-v6.8-arm64-dts-rockchip-add-USB3-host-on-rk3588s-orangepi-5.patch b/target/linux/rockchip/patches-6.1/055-02-v6.8-arm64-dts-rockchip-add-USB3-host-on-rk3588s-orangepi-5.patch
new file mode 100644
index 00000000000..a9da2e5ccb0
--- /dev/null
+++ b/target/linux/rockchip/patches-6.1/055-02-v6.8-arm64-dts-rockchip-add-USB3-host-on-rk3588s-orangepi-5.patch
@@ -0,0 +1,24 @@
+From 9ecf44fedc17ff267968b5fff589bf6793fc7ddd Mon Sep 17 00:00:00 2001
+From: Jimmy Hon <honyuenkwun@gmail.com>
+Date: Sun, 26 Nov 2023 14:08:45 -0600
+Subject: [PATCH] arm64: dts: rockchip: add USB3 host on rk3588s-orangepi-5
+
+Enable USB3 host controller for the Orange Pi 5.
+
+Signed-off-by: Jimmy Hon <honyuenkwun@gmail.com>
+Link: https://lore.kernel.org/r/20231126200845.1192-1-honyuenkwun@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+--- a/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
+@@ -660,3 +660,7 @@
+ &usb_host1_ohci {
+ 	status = "okay";
+ };
++
++&usb_host2_xhci {
++	status = "okay";
++};
diff --git a/target/linux/rockchip/patches-6.1/055-03-v6.8-arm64-dts-rockchip-Support-poweroff-on-Orange-Pi-5.patch b/target/linux/rockchip/patches-6.1/055-03-v6.8-arm64-dts-rockchip-Support-poweroff-on-Orange-Pi-5.patch
new file mode 100644
index 00000000000..86fe11bafc3
--- /dev/null
+++ b/target/linux/rockchip/patches-6.1/055-03-v6.8-arm64-dts-rockchip-Support-poweroff-on-Orange-Pi-5.patch
@@ -0,0 +1,25 @@
+From e9126f9d3c83acbc88461a535e24c949c7e0b6ca Mon Sep 17 00:00:00 2001
+From: Jimmy Hon <honyuenkwun@gmail.com>
+Date: Wed, 27 Dec 2023 14:32:11 -0600
+Subject: [PATCH] arm64: dts: rockchip: Support poweroff on Orange Pi 5
+
+The RK806 on the Orange Pi 5 can be used to power on/off the whole board.
+Mark it as the system power controller.
+
+Signed-off-by: Jimmy Hon <honyuenkwun@gmail.com>
+Link: https://lore.kernel.org/r/20231227203211.1047-1-honyuenkwun@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts | 1 +
+ 1 file changed, 1 insertion(+)
+
+--- a/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
+@@ -314,6 +314,7 @@
+ 		pinctrl-0 = <&pmic_pins>, <&rk806_dvs1_null>,
+ 				<&rk806_dvs2_null>, <&rk806_dvs3_null>;
+ 		spi-max-frequency = <1000000>;
++		system-power-controller;
+ 
+ 		vcc1-supply = <&vcc5v0_sys>;
+ 		vcc2-supply = <&vcc5v0_sys>;
diff --git a/target/linux/rockchip/patches-6.1/100-rockchip-use-system-LED-for-OpenWrt.patch b/target/linux/rockchip/patches-6.1/100-rockchip-use-system-LED-for-OpenWrt.patch
index 8e99d9c8d19..76629ff8f4c 100644
--- a/target/linux/rockchip/patches-6.1/100-rockchip-use-system-LED-for-OpenWrt.patch
+++ b/target/linux/rockchip/patches-6.1/100-rockchip-use-system-LED-for-OpenWrt.patch
@@ -375,6 +375,29 @@ Signed-off-by: David Bauer <mail@david-bauer.net>
  		};
  	};
  
+--- a/arch/arm64/boot/dts/rockchip/rk3588-orangepi-5-plus.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3588-orangepi-5-plus.dts
+@@ -20,6 +20,11 @@
+ 		mmc0 = &sdhci;
+ 		mmc1 = &sdmmc;
+ 		serial2 = &uart2;
++
++		led-boot = &status_led;
++		led-failsafe = &status_led;
++		led-running = &status_led;
++		led-upgrade = &status_led;
+ 	};
+ 
+ 	chosen {
+@@ -78,7 +83,7 @@
+ 		pinctrl-names = "default";
+ 		pinctrl-0 = <&blue_led_pin>;
+ 
+-		led {
++		status_led: led {
+ 			color = <LED_COLOR_ID_BLUE>;
+ 			function = LED_FUNCTION_INDICATOR;
+ 			function-enumerator = <1>;
 --- a/arch/arm64/boot/dts/rockchip/rk3588-rock-5b.dts
 +++ b/arch/arm64/boot/dts/rockchip/rk3588-rock-5b.dts
 @@ -15,6 +15,11 @@
@@ -403,6 +426,32 @@ Signed-off-by: David Bauer <mail@david-bauer.net>
  		};
  	};
  
+--- a/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3588s-orangepi-5.dts
+@@ -15,6 +15,11 @@
+ 	aliases {
+ 		mmc0 = &sdmmc;
+ 		serial2 = &uart2;
++
++		led-boot = &status_led;
++		led-failsafe = &status_led;
++		led-running = &status_led;
++		led-upgrade = &status_led;
+ 	};
+ 
+ 	chosen {
+@@ -40,10 +45,9 @@
+ 		pinctrl-names = "default";
+ 		pinctrl-0 =<&leds_gpio>;
+ 
+-		led-1 {
++		status_led: led-1 {
+ 			gpios = <&gpio1 RK_PA2 GPIO_ACTIVE_HIGH>;
+ 			label = "status_led";
+-			linux,default-trigger = "heartbeat";
+ 		};
+ 	};
+ 
 --- a/arch/arm64/boot/dts/rockchip/rk3588s-rock-5a.dts
 +++ b/arch/arm64/boot/dts/rockchip/rk3588s-rock-5a.dts
 @@ -9,12 +9,17 @@
diff --git a/target/linux/rockchip/patches-6.1/210-rockchip-rk356x-add-support-for-new-boards.patch b/target/linux/rockchip/patches-6.1/210-rockchip-rk356x-add-support-for-new-boards.patch
index d3096b4f802..8f989207bf1 100644
--- a/target/linux/rockchip/patches-6.1/210-rockchip-rk356x-add-support-for-new-boards.patch
+++ b/target/linux/rockchip/patches-6.1/210-rockchip-rk356x-add-support-for-new-boards.patch
@@ -24,10 +24,11 @@
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3568-nanopi-r5c.dtb
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3568-nanopi-r5s.dtb
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3568-roc-pc.dtb
-@@ -84,4 +87,6 @@ dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3568-ro
- dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-evb1-v10.dtb
+@@ -85,5 +88,7 @@ dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-ev
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-nanopc-t6.dtb
+ dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-orangepi-5-plus.dtb
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588-rock-5b.dtb
 +dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-r6c.dtb
 +dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-r6s.dtb
  dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-rock-5a.dtb
+ dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-orangepi-5.dtb
